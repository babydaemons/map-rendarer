<!DOCTYPE html>
<html>
<head>
  <title>Route Editor</title>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <script src="jquery.js" type="text/javascript"></script>
  <script src="jquery_ujs.js" type="text/javascript"></script>
  <link href="index.css" media="screen" rel="stylesheet" type="text/css" />
</head>

<body>
<div id="info">
  <div class="group">
    <div>地図中心座標</div>
    <div class="field">
      <label for="lat0">緯度</label>
      <input type="text" id="lat0" name="lat0" value="" class="latlng" readonly="readonly" />
    </div>
    <div class="field">
      <label for="lng0">経度</label>
      <input type="text" id="lng0" name="lng0" value="" class="latlng" readonly="readonly" />
    </div>
  </div>
  <div class="group">
    <div>境界座標1<input type="button" id="set1" value="設定" /></div>
    <div class="field">
      <label for="lat1">緯度</label>
      <input type="text" id="lat1" name="lat1" value="" class="latlng" readonly="readonly" />
    </div>
    <div class="field">
      <label for="lng1">経度</label>
      <input type="text" id="lng1" name="lng1" value="" class="latlng" readonly="readonly" />
    </div>
  </div>
  <div class="group">
    <div>境界座標2<input type="button" id="set2" value="設定" /></div>
    <div class="field">
      <label for="lat2">緯度</label>
      <input type="text" id="lat2" name="lat2" value="" class="latlng" readonly="readonly" />
    </div>
    <div class="field">
      <label for="lng2">経度</label>
      <input type="text" id="lng2" name="lng2" value="" class="latlng" readonly="readonly" />
    </div>
  </div>
  <div class="group">
    <div>出力しますか?<input type="button" id="exec" value="OK" disabled="disabled" /></div>
    <div id="progress">&nbsp;</div>
  </div>
</div>

<div id="map"></div>

<canvas id="workspace" width="6400" height="6400">
HTML5のcanvasタグ対応のブラウザで参照してください。
</canvas>

<script type="text/javascript" src="http://maps.googleapis.com/maps/api/js?sensor=false&language=ja"></script>
<script type="text/javascript" src="sprintf.js"></script>
<script type="text/javascript" src="boundsmarker.js"></script>
<script type="text/javascript" language="javascript">
  var map;
  var marker = [];
  var imgs = [];
  var projection, ctx;
  var latLngNE, latLngSW;
  var target = -1;
  var staticUrl = "http://maps.google.com/maps/api/staticmap?size=640x640&mobile=false&sensor=false";
  var WIDTH = 640, HEIGHT = 612;
  var TOTAL, N, M, x0, y0;
  var width, height;
  var i = 0, j = 0, n = 0;

  function initialize() {
    var center = new google.maps.LatLng(35.700000, 137.000000);
    var mapOptions = {
      zoom: 5,
      center: center,
      mapTypeId: google.maps.MapTypeId.ROADMAP // SATELLITE
    };

    map = new google.maps.Map($("#map")[0], mapOptions);
    google.maps.event.addListener(map, 'idle', update);

    update();
  }

  function update(event) {
    var positions = map.getCenter().toUrlValue().split(",");
    $("#lat0").val("%.6f".sprintf(positions[0]));
    $("#lng0").val("%.6f".sprintf(positions[1]));
  }

  function getPosition(event) {
    if (target == -1) return;
    var positions = event.latLng.toUrlValue().split(",");
    $("#lat" + target).val("%.6f".sprintf(positions[0]));
    $("#lng" + target).val("%.6f".sprintf(positions[1]));
    marker[target] = new BoundsMarker(map, event.latLng);
    $("input[type=button]#set" + target).attr("disabled", false);
    target = -1;

    drawBounds();
  }

  function drawBounds() {
    if (marker[1] === undefined) return;
    if (marker[2] === undefined) return;

    var lat1 = $("#lat1").val();
    var lng1 = $("#lng1").val();
    var lat2 = $("#lat2").val();
    var lng2 = $("#lng2").val();
    if (lat1 < lat2) { var tmp = lat1; lat1 = lat2; lat2 = tmp; }
    if (lng1 < lng2) { var tmp = lng1; lng1 = lng2; lng2 = tmp; }
    latLngNE = new google.maps.LatLng(lat1, lng1);
    latLngSW = new google.maps.LatLng(lat2, lng2);
    var bounds = new google.maps.LatLngBounds(latLngSW, latLngNE);
    var rectangleOptions = {
      bounds: bounds,
      strokeWeight: 1,
      strokeColor: "#FF0000",
      strokeOpacity: 0.5,
      fillColor: "#FF0000",
      fillOpacity: 0.1,
      map: map
    };
    var rectangle = new google.maps.Rectangle(rectangleOptions);
    $("input[type=button]#exec").attr("disabled", false);
  }

  function initTiles() {
    projection = marker[1].getProjection();
    var pointNE = projection.fromLatLngToDivPixel(latLngNE);
    var pointSW = projection.fromLatLngToDivPixel(latLngSW);
    width  = pointNE.x - pointSW.x;
    height = pointSW.y - pointNE.y;
    N = Math.ceil(width / WIDTH);
    M = Math.ceil(height / HEIGHT);
    TOTAL = N * M;

    alert(N + "個×" + M + "個の画像で作成します。"); 
    $("div#progress").html("0/" + TOTAL);

    var canvas = $("canvas#workspace");
    ctx = canvas[0].getContext("2d");

    for (var i = 0; i < N; i++) {
      var img = [];
      for (var j = 0; j < M; j++) {
        img[j] = new Image();
      }
      imgs[i] = img;
    }

    x0 = pointSW.x;
    y0 = pointNE.y;
    setTimeout(scanTiles, 1);
  }

  function scanTiles() {
    var x = x0 + i * WIDTH;
    var y = y0 + j * HEIGHT;
    putTile(ctx, imgs[i][j], projection, x, y);

    if (++i >= N) { i = 0; ++j; }
  }

  function putTile(ctx, img, projection, x, y) {
    var latLng = projection.fromDivPixelToLatLng(new google.maps.Point(x, y));
    var url = staticUrl + "&zoom=" + map.getZoom() + "&center=" + latLng.lat() + "," + latLng.lng();
    img.onload = function() {
      ctx.drawImage(img, Math.round(x - (WIDTH / 2)), Math.round(y - (HEIGHT) / 2));
      $("div#progress").html(++n + "/" + TOTAL);
      setTimeout((n < TOTAL) ? scanTiles : saveTiles, 1);
    }
    img.src = url;
  }

  function saveTiles() {
    //var dataUrl = $("canvas#workspace")[0].toDataURL("image/png");
    //$("div#progress").html('<a href="' + dataUrl + '" target="_blank">ダウンロード</a>');
    $("div#map").css("display", "none");
    $("div#info").css("display", "none");
    $("canvas#workspace").css("display", "inline");
  }

  $(function() {
    $(window).resize(function() {
      $("#map").width($("body").width() - $("#info").width());
      //$("canvas#workspace").width($("body").width() - 20);
      //$("canvas#workspace").height($("body").height() - 20);
    });

    $("input[type=button]#set1,input[type=button]#set2").click(function() {
      google.maps.event.addListener(map, "click", getPosition);
      $(this).attr("disabled", true);
      target = $(this).attr("id").replace(/set/, "");
    });

    $("input[type=button]#exec").click(function() {
      initTiles();
    });

    $(window).resize();
    initialize();
  });
</script>
</body>
</html>

